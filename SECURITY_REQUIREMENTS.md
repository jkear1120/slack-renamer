## セキュア実装の要件（実装要件）

本ドキュメントは Slack Renamer の安全な設計・実装・運用のための要件をまとめたものです。実装・レビュー時は下記の「要件」と「受け入れ基準」を満たすこと。

### トークン・認証
- 環境変数管理: Slack トークン（`SLACK_USER_TOKEN`, `SLACK_ADMIN_TOKEN`）は環境変数で注入すること。リポジトリや静的ファイルに含めない。
- 最小権限: 必要スコープのみを付与（一覧: `channels:read`, `groups:read`／更新: `channels:manage`, `groups:write`／Admin: `admin.conversations:write`）。
- 表示制御: UI・ログ・CSVにトークンや個人情報を出力しない。
- 受け入れ基準: トークンは `.gitignore` 対象であり、ログ/画面/CSVに出力されないこと。

### 通信・CORS・CSRF
- 通信路: 管理者端末からローカル実行を前提。プロキシ越し配布時は HTTPS を必須にする。
- CORS: デフォルトは同一オリジンのみ。配布形態に応じて必要最小限に限定。
- CSRF: 状態変更系（適用/リバート）は POST のみ。将来的に外部配布する場合は CSRF 対策（SameSite/トークン）を導入。
- 受け入れ基準: 状態変更APIが GET を受け付けないこと、CORS が無制限でないこと。

### 入力検証・ファイルアップロード
- アップロード制限: CSV は 10MB 以下。MIME/拡張子を確認し、想定外は拒否。
- CSV検証: 欠損や不正列はスキップし、結果に理由を明示（`invalid`/`skipped`）。
- 正規化: チャンネル名は NFKC + 80 文字制限 + 先頭は文字/数字 + 許容文字（Unicode文字/数字/`_`/`-`）。
- 受け入れ基準: 想定外入力でサーバが例外終了しないこと、エラー理由が応答に含まれること。

### ログ・監査・復旧
- 二系統ログ: 人間可読（`.log`）と機械可読（`.jsonl`）を `logs/` に保存。
- 履歴保存: エクスポートCSV（`export-<ts>.csv`）とインポートCSV（`import-<batch>.csv`）を保存。
- 取消（リバート）: 適用ごとに `revert-<batch>.json` を保存し、一括復旧 API（`POST /api/rename/revert?batch_id=`）を提供。UI から直前バッチの復旧が可能。
- 受け入れ基準: 適用後にバッチIDが払い出され、復旧ファイルが生成・利用できること。

### レート制御・エラーハンドリング
- 再試行: Slack SDK のリトライ機構に任せつつ、429 `Retry-After` をログ化。
- 失敗処理: 1件失敗しても他の処理は継続。失敗詳細（`error`）を結果と JSONL に記録。
- 受け入れ基準: 長時間処理での一部失敗が全体を止めず、結果に失敗理由が含まれること。

### 権限・ロール
- 実行ロール: Workspace はチャンネル作成者/Workspace Admin/Channel Manager、Admin は Org Admin。
- Admin操作: UI で Adminモードを明示。誤操作防止のため本番反映は「最終確認」チェックを必須化。
- 受け入れ基準: Adminモードが明確で、最終確認なしに適用できないこと。

### API安全性
- パス操作防止: ログ閲覧 API（`/api/logs/get|view`）は `..` や `/` を含む名前を拒否。
- 入力制限: `include_archived` 等の真偽値/列挙は明示的にパースし、デフォルトセーフに。
- 受け入れ基準: 明示的な入力検証があり、ディレクトリトラバーサルが不可能であること。

### 依存管理・ビルド
- ピン留め: 依存はメジャー互換範囲に制限し、`npm audit` で既知脆弱性を監視。
- 秘密情報: `.env` を使う場合は `.gitignore` 済み。サンプル `.env.example` でキー名のみ共有。
- 受け入れ基準: 既知の重大脆弱性が検出されないこと、秘密情報がソース管理に含まれないこと。

### UX・安全装置
- プレビュー重視: 「プレビュー」画面で差分を確認（`will_rename/invalid/noop`）。
- 可視化: アーカイブ行をハイライト、検索/絞り込み/並び替えを提供。
- 確認: 本番反映はチェックボックスによる最終確認必須。
- 受け入れ基準: プレビューで誤りを発見でき、誤適用を UI 上で抑制できること。

---

最終更新: 2025-09-29
