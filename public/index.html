<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Slack Channel CSV Renamer</title>
    <style>
      :root {
        --bg: #17130f; /* warm dark */
        --panel: #1f1a14ee; /* warm dark panel */
        --text: #f3f4f6; /* light text */
        --muted: #cbd5e1; /* muted */
        --brand: #f59e0b; /* amber-500 */
        --brand-2: #f43f5e; /* rose-500 */
        --ok: #10b981; /* emerald-500 */
        --warn: #f59e0b; /* amber-500 */
        --err: #ef4444; /* red-500 */
        --border: #3f2f21; /* warm border */
      }
      body {
        margin: 0; padding: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background:
          radial-gradient(60% 120% at 0% 0%, rgba(245,158,11,.25), transparent 60%),
          radial-gradient(80% 140% at 100% 0%, rgba(244,63,94,.22), transparent 60%),
          var(--bg);
        min-height: 100vh;
      }
      header {
        padding: 24px 24px 12px 24px;
        display:flex; justify-content: space-between; align-items: center;
      }
      h2 { margin: 0; font-weight: 650; letter-spacing: .2px; }
      .sub { color: var(--muted); font-size: 12px; }
      .container { padding: 0 24px 32px 24px; }
      .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
      .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; backdrop-filter: blur(6px); }
      .wide { grid-column: 1 / -1; }
      .controls { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
      label { font-size: 13px; color: var(--text); }
      input[type="text"], input[type="file"] { background: transparent; color: var(--text); border: 1px solid var(--border); padding: 6px 8px; border-radius: 8px; }
      .btn { border: 1px solid var(--border); color: white; background: linear-gradient(135deg, var(--brand), var(--brand-2)); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 8px 24px rgba(245,158,11,.25); }
      .btn.secondary { background: transparent; color: var(--text); border-color: #334155; }
      .btn:disabled { opacity: .6; cursor: not-allowed; }
      .kpi { font-variant-numeric: tabular-nums; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 12px; }
      thead th { position: sticky; top: 0; background: #0b1220; z-index: 1; }
      th, td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; }
      .chip { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; border: 1px solid var(--border); }
      .chip.ok { background: rgba(16,185,129,.1); color: #34d399; }
      .chip.warn { background: rgba(245,158,11,.1); color: #fbbf24; }
      .chip.err { background: rgba(239,68,68,.1); color: #f87171; }
      .row-gap { height: 6px; }
      .toggle { display:flex; align-items:center; gap:8px; color: var(--muted); }
      .muted { color: var(--muted); font-size: 12px; }
      .header-actions { display:flex; gap:10px; align-items:center; }
    </style>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <header>
      <div>
        <h2>Slack Channel CSV Renamer</h2>
        <div class="sub">CSVで編集して、一括でチャンネル名を更新</div>
      </div>
      <div class="header-actions">
        <label class="toggle"><input type="checkbox" id="adminMode" /> Adminモード</label>
        <label class="toggle"><input type="checkbox" id="themeToggle" /> ダークモード</label>
      </div>
    </header>

    <div class="container">
      <div class="row">
        <div class="card">
          <h3 style="margin-top:0">トークン状態</h3>
          <div id="authStatus" class="muted">Loading...</div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">エクスポート</h3>
          <div class="controls">
            <label>types: <input id="types" value="public_channel,private_channel" style="width:220px"/></label>
          </div>
          <label class="toggle"><input type="checkbox" id="includeArchived" /> アーカイブも含める</label>
          <div style="margin-top:8px;"><button class="btn" id="btnExport">CSVダウンロード</button></div>
        </div>

        <div class="card wide">
          <h3 style="margin-top:0">CSVインポート → プレビュー/適用</h3>
          <div class="muted">`new_name` 列に変更後の名前を入れてください。`NOTE` は任意です。</div>
          <div class="row-gap"></div>
          <input type="file" id="csvFile" accept=".csv" />
          <div class="controls" style="margin-top:8px;">
            <button class="btn secondary" id="btnPreview">プレビュー</button>
            <label class="toggle"><input type="checkbox" id="finalConfirm" /> 最終確認しました</label>
            <button class="btn" id="btnApply" disabled>本番反映</button>
          </div>
          <div id="result"></div>
        </div>
      </div>
    </div>

    <script>
      async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }

      async function refreshAuth() {
        try {
          const s = await fetchJSON('/api/auth-status');
          const user = s.user?.ok ? `User: OK (user=${s.user.user}, team=${s.user.team})` : 'User: 未設定';
          const admin = s.admin?.ok ? `Admin: OK (user=${s.admin.user}, team=${s.admin.team})` : 'Admin: 未設定';
          document.getElementById('authStatus').textContent = `${user} / ${admin}`;
        } catch (e) {
          document.getElementById('authStatus').textContent = 'エラー: ' + e.message;
        }
      }

      document.getElementById('btnExport').addEventListener('click', () => {
        const types = document.getElementById('types').value || 'public_channel,private_channel';
        const includeArchived = document.getElementById('includeArchived').checked;
        const q = new URLSearchParams({ types, include_archived: includeArchived ? 'true' : 'false' }).toString();
        location.href = `/api/channels/export?${q}`;
      });

      function getAdminFlag() {
        return document.getElementById('adminMode').checked;
      }

      function readCSVFile(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (res) => resolve(res.data),
            error: (err) => reject(err)
          });
        });
      }

      async function postRows(url, rows) {
        const r = await fetch(url + `?admin=${getAdminFlag()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rows })
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }

      async function handlePreview() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert('CSVファイルを選択してください');
        const rows = await readCSVFile(file);
        const res = await postRows('/api/rename/dry-run', rows);
        renderResult(res.plan || res.results || [], { title: 'プレビュー結果' });
      }

      async function handleApply() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert('CSVファイルを選択してください');
        if (!document.getElementById('finalConfirm').checked) {
          return alert('本番反映には「最終確認しました」にチェックが必要です。');
        }
        const rows = await readCSVFile(file);
        const res = await postRows('/api/rename/apply', rows);
        renderResult(res.results || [], { title: '適用結果', mode: 'apply' });
        if (res.logs) {
          const div = document.createElement('div');
          div.textContent = `ログ: ${res.logs.logPath} / ${res.logs.jsonlPath}`;
          document.getElementById('result').prepend(div);
        }
      }

      function renderResult(items, opts = {}) {
        const resultEl = document.getElementById('result');
        if (!items.length) { resultEl.textContent = '結果なし'; return; }
        const title = opts.title || '結果';
        const mode = opts.mode || 'preview';
        // 列定義（存在する列のみ表示）
        const jpMap = {
          channel_id: 'チャンネルID',
          current_name: '現在名',
          requested_name: '希望名',
          normalized_name: '正規化後',
          status: 'ステータス',
          reason: '理由',
          notes: 'メモ',
          NOTE: 'メモ',
          channel_type: '種別',
          archived: 'アーカイブ',
          from: '変更前',
          to: '変更後',
          api_result: 'API結果',
          error: 'エラー',
          ts: '時刻'
        };
        const prefCols = mode === 'apply'
          ? ['channel_id','from','to','status','error','api_result','notes']
          : ['channel_id','current_name','requested_name','normalized_name','status','reason','notes'];
        const sample = items[0];
        const dynamicExtras = Object.keys(sample).filter(k => !prefCols.includes(k));
        const cols = [...prefCols.filter(k => k in sample), ...dynamicExtras];

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const thr = document.createElement('tr');
        cols.forEach(h => { const th = document.createElement('th'); th.textContent = jpMap[h] || h; thr.appendChild(th); });
        thead.appendChild(thr); table.appendChild(thead);
        const tbody = document.createElement('tbody');
        items.forEach(row => {
          const tr = document.createElement('tr');
          cols.forEach(h => {
            const td = document.createElement('td');
            let v = row[h];
            if (h === 'ts' && v) {
              try { v = new Date(v).toLocaleString(); } catch {}
            }
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        resultEl.innerHTML = '';
        const h = document.createElement('div');
        h.textContent = title;
        h.style.marginTop = '12px';
        h.style.fontWeight = '600';
        resultEl.appendChild(h);
        resultEl.appendChild(table);
      }

      document.getElementById('btnPreview').addEventListener('click', () => handlePreview().catch(e => alert(e.message)));
      document.getElementById('btnApply').addEventListener('click', () => handleApply().catch(e => alert(e.message)));

      refreshAuth();

      // Theme toggle (persist)
      const themeToggle = document.getElementById('themeToggle');
      try {
        const saved = localStorage.getItem('theme:dark') === 'true';
        themeToggle.checked = saved;
        document.body.dataset.dark = saved ? '1' : '';
      } catch {}
      themeToggle.addEventListener('change', () => {
        const v = themeToggle.checked;
        document.body.dataset.dark = v ? '1' : '';
        try { localStorage.setItem('theme:dark', String(v)); } catch {}
      });

      // 最終確認チェックで有効化
      const finalConfirm = document.getElementById('finalConfirm');
      const btnApply = document.getElementById('btnApply');
      finalConfirm.addEventListener('change', () => {
        btnApply.disabled = !finalConfirm.checked;
      });
    </script>
  </body>
  </html>
